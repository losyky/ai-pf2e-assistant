/**
 * PF2e 核心规则机制知识库
 * 用于指导AI生成符合PF2e规则的机制描述
 * 
 * 注意：这不是Foundry VTT的Rule Elements，而是PF2e游戏本身的规则要素
 */

export const PF2E_MECHANICS_KNOWLEDGE = `
# PF2e 核心规则机制知识库

## 1. 动作系统 (Actions)

### 动作类型
- **单动作** (1 action, ◆): 大部分攻击、移动、施法
- **双动作** (2 actions, ◆◆): 复杂攻击、长时间施法
- **三动作** (3 actions, ◆◆◆): 强力技能、仪式施法
- **自由动作** (Free Action, ◇): 不消耗动作，每轮有限次数
- **反应动作** (Reaction, ↻): 在他人回合触发，每轮1次
- **被动能力** (Passive): 持续生效，无需激活

### 动作经济原则
- 每回合3个动作
- 合理分配动作成本：强力效果 = 更多动作
- 反应动作必须有明确触发条件
- 自由动作通常有使用限制（如"每轮一次"）

---

## 2. 频次限制 (Frequency)

### 标准频次
- **无限制**: 只要满足条件就能使用
- **每轮一次**: 战术回合内限制
- **每场战斗一次**: 单次遭遇限制
- **每小时一次**: 短期休息周期
- **每天X次**: 日常使用限制
- **每周一次**: 强力能力

### 频次设计原则
- 强力效果需要更严格的频次限制
- 被动效果通常无频次限制
- 恢复机制：每日恢复、短休恢复、等级提升恢复

---

## 3. 触发条件 (Trigger)

### 常见触发
- **攻击命中你**: "当你被攻击命中时"
- **移动离开**: "当敌人试图离开你的触及范围时"
- **施法**: "当你施放法术时"
- **豁免失败**: "当你豁免失败时"
- **生命值降低**: "当你的HP降至一半以下时"
- **回合开始/结束**: "在你的回合开始时"

### 触发条件写作
- 必须具体明确
- 包含主语（你、敌人、盟友）
- 说明时间点（之前、之后、期间）
- 例："当一个敌人在你的触及范围内进行攻击检定时"

---

## 4. 持续时间 (Duration)

### 常见持续时间
- **瞬间**: 效果立即发生，无持续
- **1轮**: 直到你的下一个回合开始
- **1分钟**: 10轮，短期战斗buff
- **10分钟**: 探索期间的增益
- **1小时**: 中等时长增益
- **直到下一次休息**: 长期buff
- **永久**: 角色永久获得的能力

### 持续时间设计
- 强力效果 = 短持续时间
- 探索增益 = 10分钟或更长
- 战斗增益 = 1轮到1分钟
- 可以有提前终止条件

---

## 5. 修正值类型 (Bonus Types)

### 三大修正类型
1. **环境加值 (Circumstance)**: 来自战术位置、环境因素
   - 例：侧翼攻击 +2（最常见的环境加值），高地优势 +1
   - 特点：相对少见，通常需要战术操作获得
   
2. **状态加值 (Status)**: 来自法术、能力、状态效果
   - 例：英勇激励 +1，祝福术 +1，吟游诗人鼓舞 +1
   - 特点：较容易获得，各职业都有提供状态加值的能力
   
3. **物品加值 (Item)**: 来自装备、魔法物品
   - 例：+1武器（攻击和伤害），+1护甲（AC）
   - 特点：需要装备支持，通常在特定等级才能获得

### 修正值堆叠规则（核心平衡机制）
- **同类型不堆叠**: 只取最高值（这是PF2e平衡的核心）
- **不同类型可堆叠**: 环境+状态+物品可以同时生效
- **无类型加值**: 除非特别说明，否则可以堆叠（非常罕见）
- **实际案例**: 
  - ✅ 可叠加：侧翼(环境+2) + 英勇激励(状态+1) + 魔法武器(物品+1) = +4总加值
  - ❌ 不叠加：英勇激励(状态+1) + 祝福术(状态+1) = 只有+1（取最高）

### 减值 (Penalties)
- **环境减值**: 困难地形、视线遮蔽
- **状态减值**: 疲乏、受伤
- **物品减值**: 破损装备
- 减值规则同加值，同类型取最大

---

## 6. 检定与DC (Checks & DC)

### 检定类型
- **技能检定**: d20 + 技能修正
- **攻击检定**: d20 + 攻击修正 vs AC
- **豁免检定**: d20 + 豁免修正 vs DC
- **感知检定**: d20 + 感知修正

### 成功度 (Degree of Success)
- **大成功**: 超过DC 10+
- **成功**: 达到或超过DC
- **失败**: 低于DC
- **大失败**: 低于DC 10+

### DC等级
- **简单**: DC 15
- **中等**: DC 20
- **困难**: DC 25
- **极难**: DC 30+
- **可变DC**: 等于目标的对应防御值；角色的职业DC

---

## 7. 伤害系统 (Damage)

### 伤害类型
**物理伤害**:
- 钝击 (Bludgeoning)
- 穿刺 (Piercing)
- 挥砍 (Slashing)

**能量伤害**:
- 酸液 (Acid)
- 寒冷 (Cold)
- 电击 (Electricity)
- 火焰 (Fire)
- 音波 (Sonic)

**特殊伤害**:
- 力场 (Force)
- 负能量 (Negative)
- 正能量 (Positive)
- 精神 (Mental)
- 毒素 (Poison)

### 伤害表达
- **固定伤害**: "造成5点火焰伤害"
- **骰子伤害**: "造成2d6点火焰伤害"
- **额外伤害**: "你的攻击额外造成1d6点火焰伤害"
- **持续伤害**: "目标在其回合开始时受到1d6持续火焰伤害"

### 抗性与弱点
- **抗性**: "对火焰伤害有抗性5"（减少5点伤害）
- **弱点**: "对寒冷伤害有弱点5"（额外受到5点伤害）
- **免疫**: "免疫毒素伤害"

---

## 8. 特征标签 (Traits)

### 攻击特征
- **Agile**: 多次攻击减值减少（-4/-8变为-3/-6）
- **Deadly**: 重击时额外骰子
- **Fatal**: 重击时伤害骰升级
- **Finesse**: 可用敏捷替代力量
- **Reach**: 触及10尺
- **Thrown**: 可投掷

### 法术特征
- **Concentrate**: 需要专注，受到伤害可能中断
- **Manipulate**: 需要手部动作，触发攻击机会
- **Verbal**: 需要言语，沉默状态无法使用
- **Somatic**: 需要姿势，束缚状态无法使用

### 状态特征
- **Concealed**: 隐蔽，攻击者-2检定
- **Flat-footed**: 措手不及，AC-2
- **Prone**: 俯卧，近战AC-2，远程AC+2
- **Stunned**: 震慑，失去动作（极强力的控制状态）
- **Slowed**: 缓慢，减少可用动作数（强力debuff）
- **Quickened**: 加速，增加额外动作（强力buff）

### ⚠️ 动作经济状态的重要性
**在PF2e中，动作经济是核心平衡机制。影响动作数的效果极其强力：**

#### 震慑 (Stunned)
- **效果**: 失去指定数量的动作（通常1-3个动作）
- **强度**: 🔴 **极强力控制**
- **评价**: 震慑1 = 失去1个动作，震慑2 = 失去2个动作，震慑3+ = 几乎失去整个回合
- **设计建议**: 
  - 震慑1：需要成功的豁免检定或有严格触发条件，持续1轮
  - 震慑2：应该是高等级能力，每天1次或需要大失败
  - 震慑3：应该是极高等级的终极能力，严格限制使用
- **平衡案例**: 大多数震慑效果只持续1轮，且需要失败豁免

#### 缓慢 (Slowed)
- **效果**: 每回合减少1个动作（缓慢1）或更多（缓慢2极罕见）
- **强度**: 🟠 **强力debuff**
- **评价**: 将3动作变成2动作，严重限制战术选择
- **设计建议**:
  - 缓慢1：中等级能力，需要失败豁免，持续1分钟或直到豁免成功
  - 缓慢2：高等级能力，严格限制，通常持续很短或需要大失败
- **战术影响**: 
  - 无法在1回合内移动+攻击+再攻击
  - 无法使用3动作技能
  - 施法者无法移动后施放2动作法术
- **平衡案例**: 通常允许每轮豁免尝试移除效果

#### 加速 (Quickened)
- **效果**: 每回合额外获得1个动作（通常有使用限制）
- **强度**: 🟢 **强力buff**（但有严格限制）
- **评价**: 将3动作变成4动作，显著提升战术灵活性
- **设计建议**:
  - 额外动作**必须有使用限制**（例：只能用于移动、打击或施法）
  - 通常是高等级法术（7环+）或每天1次的强力能力
  - 持续时间短（1分钟）且需要专注维持
- **战术影响**:
  - 额外移动=更好的战场控制
  - 额外打击=显著提升伤害输出
  - 额外施法=法术位利用率大幅提升
- **平衡要点**: 
  - ❌ 绝不给予"无限制使用的额外动作"
  - ✅ 必须指定额外动作的用途（"额外1个打击动作"而非"额外1个动作"）
  - ✅ 高等级能力或严格频次限制

#### 动作经济效果的设计原则
1. **震慑/缓慢/加速不应轻易给予**，它们改变游戏节奏
2. **持续时间要短**：通常1轮（震慑）到1分钟（缓慢/加速）
3. **需要豁免检定**：给予目标抵抗机会
4. **频次严格限制**：这类效果不应该是"随意使用"的
5. **等级门槛**：
   - 震慑1: 3级+
   - 加速: 5级+（对应3环法术，且有严格使用限制）
   - 缓慢1: 5级+
   - 震慑2/缓慢2: 10级+
6. **与其他效果平衡**：
   - 震慑1 ≈ 造成等级×2d6的伤害（在价值上）
   - 缓慢1持续1分钟 ≈ 每天1次的强力能力
   - 加速 ≈ 3环法术的强度（5级角色可用）

---

## 9. 前置条件 (Requirements & Prerequisites)

### 技能要求
- **技能等级**: "精通杂技"、"专家隐秘"
- **技能修正**: "运动修正至少+10"

### 属性要求
- **属性值**: "力量14+"、"智力16+"
- **属性修正**: "敏捷修正+3"

### 职业/种族要求
- **职业特性**: "狂暴职业特性"
- **族裔**: "精灵族裔"

### 等级要求
- **角色等级**: "5级"、"10级"
- **专长等级**: "需要先有XX专长"

### 装备要求
- **武器类型**: "持有剑类武器"
- **护甲类型**: "穿着轻甲或无甲"
- **盾牌**: "使用盾牌"

---

## 10. 范围与目标 (Range & Targets)

### 范围类型
- **触及 (Reach)**: 近战范围，通常5尺
- **距离 (Range)**: 远程距离，如"30尺"、"60尺"
- **爆发 (Burst)**: 半径范围，如"10尺爆发"
- **锥形 (Cone)**: "15尺锥形"
- **线形 (Line)**: "30尺线形"

### 目标选择
- **自己**: "你"
- **单一目标**: "一个生物"
- **多个目标**: "最多3个生物"
- **范围内所有**: "爆发范围内所有敌人"
- **选择性**: "范围内你选择的盟友"

### 视线与遮蔽
- **需要视线**: "你能看到的一个生物"
- **忽略遮蔽**: "即使有完全遮蔽也能影响"
- **遮蔽影响**: "目标获得标准遮蔽加值"

---

## 11. 机制组合原则

### 平衡设计
1. **动作成本 ↔ 效果强度**: 
   - 3动作 = 强力效果
   - 反应动作 = 中等防御/反击
   - 被动 = 小幅持续增益

2. **频次 ↔ 效果强度**:
   - 无限制 = 弱效果
   - 每战斗一次 = 中等效果
   - 每天一次 = 强力效果

3. **持续时间 ↔ 效果强度**:
   - 永久 = 小幅增益
   - 1分钟 = 中等增益
   - 1轮 = 强力增益

### 常见组合模式
- **攻击增益**: 单动作 + 1分钟 + 每战斗一次
- **防御反应**: 反应动作 + 触发条件 + 无限制
- **爆发伤害**: 2-3动作 + 瞬间 + 每天一次
- **持续控制**: 2动作 + 1分钟 + 专注维持
- **被动增益**: 无动作 + 永久 + 条件触发

---

## 12. 机制描述模板

### 攻击型能力
\`\`\`
【动作】单动作 ◆
【频次】每场战斗一次
【触发】无（主动使用）
【效果】你进行一次近战攻击。若命中，除正常伤害外，目标还受到1d6持续火焰伤害。
【特殊】此攻击无视目标5点抗性。
\`\`\`

### 防御型能力
\`\`\`
【动作】反应动作 ↻
【频次】每轮一次
【触发】你被一次近战攻击命中
【效果】你的AC获得+2环境加值对抗触发的攻击。若此加值使攻击未命中，你可以立即向攻击者进行一次反击。
\`\`\`

### 增益型能力
\`\`\`
【动作】双动作 ◆◆
【频次】每天一次
【持续】1分钟
【效果】你和30尺内的所有盟友的攻击检定和伤害骰获得+2状态加值。
【特殊】此效果需要专注维持，受到伤害时需通过DC 15的意志豁免，否则效果提前结束。
\`\`\`

### 被动型能力
\`\`\`
【动作】被动
【触发】你进行近战攻击命中时
【效果】你的近战攻击额外造成1d6火焰伤害。若攻击是重击，改为造成2d6火焰伤害。
\`\`\`

---

## 13. 关键术语标准化

### 检定相关
- "进行一次XX检定" 而非 "投XX"
- "检定结果" 而非 "骰值"
- "对抗DC" 而非 "难度"

### 伤害相关
- "造成伤害" 而非 "打出伤害"
- "受到伤害" 而非 "扣血"
- "生命值" 而非 "HP"或"血量"

### 动作相关
- "使用/花费一个动作" 而非 "消耗动作"
- "在你的回合" 而非 "你的回合时"
- "作为反应动作" 而非 "反应"

### 目标相关
- "一个生物" 而非 "一个目标"（除非明确是物体）
- "你能看到的" 而非 "视线内"
- "触及范围内" 而非 "近战距离"

---

## 14. 常见错误避免

### ❌ 错误示例
- "你可以自由移动而不触发机会攻击" （过于宽泛）
- "造成大量伤害" （不具体）
- "获得很大的加值" （模糊）
- "可以使用多次" （频次不明）

### ✅ 正确示例
- "在此回合，你的移动不触发攻击机会"
- "造成3d6点火焰伤害"
- "获得+3状态加值"
- "每小时可使用一次"

---

## 15. 机制强度参考

### 重要说明
- **加值上限**: 在PF2e中，由于熟练加值系统，数值平衡非常严格
- **典型加值范围**: +1到+3，极少数情况+4
- **攻击加值**: 特别敏感，+1已经显著，+2非常强力，+3极其罕见
- **状态加值**: 相对容易获得（法术、能力）
- **环境加值**: 较为少见（战术位置、特殊情况）
- **同类型不叠加**: 只取最高值，这是核心平衡机制


✅ **始终考虑等级缩放** - 大多数数值效果应该随角色等级增长

### 弱效果（无限制或条件触发）
- **加值**: +1加值（环境或状况）
- **攻击追加的额外伤害**: 单次攻击每4级1d4点额外伤害，或持续时间内每4级1点额外伤害
- **直接的范围伤害**:  等级*d4的伤害，或任意期望值与之相当的伤害
- **直接的单体伤害**: 等级*d6的伤害，或任意期望值与之相当的伤害
- **治疗**: 等级*d6的治疗，或任意期望值与之相当的治疗
- **持续伤害**: 每4级1d4点持续伤害
- **移动**: +5尺或+10尺移动速度
- **检定**: 技能重投（有严格条件限制）
- **临时HP**: 等级或等级×2（例：1级=1-2点，5级=5-10点，10级=10-20点）
- **持续时间**: 1轮或非常短

### 中等效果（每10分钟1次或有代价）
- **加值**: +1状态加值持续1分钟，或+2加值持续1轮
- **攻击追加的额外伤害**: 单次攻击每4级1d6点额外伤害，或持续时间内每4级1d4点额外伤害
- **直接的范围伤害**:  等级*d6的伤害，或任意期望值与之相当的伤害
- **直接的单体伤害**: 等级*d8的伤害，或任意期望值与之相当的伤害
- **治疗**: 等级*d8的治疗，或任意期望值与之相当的治疗
- **临时HP**: 等级×2到等级×3（例：1级=2-3点，5级=10-15点，10级=20-30点）
- **自动成功**: 对抗较低DC的自动成功
- **持续时间**: 1分钟或直到触发结束

### 强效果（每天1次或严格限制）
- **加值**: +2状态加值持续1分钟
- **攻击追加的额外伤害**: 单次攻击每4级1d10点额外伤害，或持续时间内每4级1d6点额外伤害
- **直接的范围伤害**:  等级*d10的伤害，或任意期望值与之相当的伤害
- **直接的单体伤害**: 等级*d12的伤害，或任意期望值与之相当的伤害
- **治疗**: 等级*d10的治疗，或任意期望值与之相当的治疗
- **避免KO**: 避免一次濒死，但有严格限制
- **重击保证**: 将命中升级为重击（每天1次）

### 极强效果（每天1次且高等级，或重大代价）
- **加值**: +3状态加值（极其罕见，通常高等级）
- **攻击追加的额外伤害**: 单次攻击每4级1d12点额外伤害，或持续时间内每4级1d8点额外伤害
- **直接的范围伤害**:  等级*d12的伤害，或任意期望值与之相当的伤害
- **直接的单体伤害**: 等级*d12的伤害，或任意期望值与之相当的伤害
- **治疗**: 等级*d12的治疗，或任意期望值与之相当的治疗
- **完全恢复**: 恢复所有HP或所有法术位
- **战局改变**: 群体复活、改变地形、召唤强力盟友

---

## 16. 法术环级与戏法 ⚠️

### 法术环级系统
PF2e的法术分为0环（戏法）到10环，环级直接决定法术的强度和可用性。

#### 环级与角色等级对应
- **0环（戏法）**: 1级角色即可使用，无限施放
- **1环法术**: 1级角色可施放
- **2环法术**: 3级角色可施放
- **3环法术**: 5级角色可施放
- **4环法术**: 7级角色可施放
- **5环法术**: 9级角色可施放
- **6环法术**: 11级角色可施放
- **7环法术**: 13级角色可施放
- **8环法术**: 15级角色可施放
- **9环法术**: 17级角色可施放
- **10环法术**: 19级角色可施放（传奇法术）

### 戏法 (Cantrips) - 0环法术的特殊性

戏法是一类特殊的法术，具有三个核心特性：

#### 1. 无限施放
- **不消耗法术位**：戏法可以无限次施放
- **平衡要点**：正因为无限施放，戏法的效果强度必须严格控制
- **设计原则**：戏法应该是"可靠但不强力"的基础选项

#### 2. 自动升环
- **随施法者等级提升**：戏法的效果会随角色等级自动增强
- **升环规律**：通常每2级或每奇数等级提升一次
- **实现方式**：伤害骰增加、范围扩大、目标数量增加等

#### 3. 效果强度较低
由于无限施放的特性，戏法的效果必须低于同等级的普通法术

---

## 17. 动作经济效果强度评估 ⚠️

### 为什么动作经济如此重要
在PF2e中，每回合3个动作是游戏的核心平衡点。**任何增减动作数的效果都会根本性地改变战斗节奏**。

### 震慑 (Stunned) - 极强力控制

#### 震慑1（失去1个动作）
- **强度等级**: 🔴 强效果
- **建议等级**: 3级+
- **建议频次**: 每战斗1-2次，或需要成功豁免检定
- **持续时间**: 通常1轮（目标的下一个回合）
- **设计要点**:
  - 需要目标失败豁免检定（通常对抗你的职业DC）
  - 不应该是无限制使用的
  - 等效伤害价值约为等级×2d6点伤害
- **示例**: "目标必须进行强韧豁免，失败则震慑1直到其下一回合结束"

#### 震慑2（失去2个动作）
- **强度等级**: 🔴🔴 极强效果
- **建议等级**: 10级+
- **建议频次**: 每天1次，或需要大失败豁免
- **持续时间**: 1轮
- **设计要点**:
  - 通常只在豁免大失败时触发
  - 或作为高等级（10级+）的核心职业能力
  - 每天使用次数严格限制
- **示例**: "目标进行强韧豁免。失败震慑1，大失败震慑2"

#### 震慑3+（失去整个回合）
- **强度等级**: 🔴🔴🔴 战局改变级
- **建议等级**: 15级+
- **建议频次**: 每天1次，或极严格条件
- **持续时间**: 1轮
- **设计要点**:
  - 几乎等同于"跳过目标的整个回合"
  - 应该是终极能力或9环法术级别
  - 必须有反制手段（豁免、反应动作等）
- **示例**: "9环法术，目标进行意志豁免，大失败则震慑3"

### 缓慢 (Slowed) - 强力持续debuff

#### 缓慢1（每回合-1动作）
- **强度等级**: 🟠 强效果（因为可能持续多轮）
- **建议等级**: 5级+
- **建议频次**: 每战斗1次或需要失败豁免
- **持续时间**: 1分钟，通常允许每轮豁免尝试移除
- **设计要点**:
  - 比震慑1更持久，但目标仍有2个动作
  - 应该允许目标定期尝试豁免移除（如每轮结束时）
  - 对施法者和技能使用者影响巨大
  - 等效伤害价值：如果持续3轮 ≈ 等级×4d6点伤害
- **战术影响**:
  - 无法"移动+双动作攻击/施法"
  - 无法使用三动作技能
  - 严重限制战术灵活性
- **示例**: "目标进行强韧豁免，失败则缓慢1持续1分钟（每轮结束时可再次豁免）"

#### 缓慢2（每回合-2动作）
- **强度等级**: 🟠🟠 极强效果
- **建议等级**: 10级+
- **建议频次**: 每天1次，或豁免大失败
- **持续时间**: 1-3轮
- **设计要点**:
  - 目标每回合只有1个动作，几乎无法有效行动
  - 应该持续很短（1-3轮）或只在大失败时触发
  - 极其罕见的效果
- **示例**: "目标进行强韧豁免。失败缓慢1持续1分钟，大失败缓慢2持续3轮"

### 加速 (Quickened) - 强力buff（必须有限制）

#### 有限制的加速（额外动作只能用于特定用途）
- **强度等级**: 🟢 强效果
- **建议等级**: 5级+（对应3环法术Haste）
- **建议频次**: 每天1次，或高等级职业特性
- **持续时间**: 1分钟（需要专注维持）
- **设计要点**:
  - **必须限制额外动作的用途**（这是关键！）
  - 常见限制：
    - "额外动作只能用于移动"
    - "额外动作只能用于打击"
    - "额外动作只能用于施放戏法"
  - 官方Haste法术（3环）的限制："额外动作只能用于打击或移动"
- **平衡案例**: 
  - ✅ "你加速1。额外动作只能用于移动或打击"（类似Haste法术）
  - ❌ "你加速1。额外动作可以用于任何用途"（过强，不应存在）
- **示例**: "你获得加速1状态1分钟。额外动作只能用于打击或移动"

#### 无限制的加速（极罕见，不推荐）
- **强度等级**: 🟢🟢🟢 战局改变级
- **建议**: **不应该设计此类效果**
- **原因**: 
  - 完全打破动作经济平衡
  - 额外的完整动作可以用于任何事：施法、技能、物品使用等
  - 即使是9环法术Time Stop也不给予真正的"自由使用的额外动作"

### 动作经济效果的对比表

| 效果 | 强度 | 建议等级 | 建议频次 | 持续时间 | 等效价值 |
|------|------|----------|----------|----------|----------|
| 震慑1 | 🔴 强 | 3级+ | 每战斗1-2次 | 1轮 | ≈等级×2d6伤害 |
| 震慑2 | 🔴🔴 极强 | 10级+ | 每天1次 | 1轮 | ≈等级×4d6伤害 |
| 震慑3+ | 🔴🔴🔴 战局改变 | 15级+ | 每天1次 | 1轮 | ≈9环法术 |
| 缓慢1 | 🟠 强（持续） | 5级+ | 每战斗1次 | 1分钟 | ≈等级×4d6伤害（如持续3轮） |
| 缓慢2 | 🟠🟠 极强 | 10级+ | 每天1次 | 1-3轮 | ≈7环法术 |
| 加速（有限） | 🟢 强 | 5级+ | 每天1次 | 1分钟 | ≈3环法术（Haste） |
| 加速（无限） | 🟢🟢🟢 破坏平衡 | ❌不推荐 | ❌不推荐 | ❌不推荐 | 无法平衡 |

### 设计检查清单

在设计任何影响动作经济的能力时，务必检查：

- [ ] **等级门槛**：能力等级是否足够高？（震慑1: 3级+，缓慢1: 5级+，加速: 5级+）
- [ ] **频次限制**：是否有合理的使用限制？（每战斗1次、每天1次等）
- [ ] **持续时间**：是否足够短？（震慑通常1轮，缓慢/加速通常1分钟）
- [ ] **豁免机会**：目标是否有抵抗机会？（大多数情况需要豁免检定）
- [ ] **移除机制**：是否有提前结束的方式？（缓慢通常允许每轮豁免）
- [ ] **使用限制**（加速专用）：额外动作的用途是否受限？（必须限制！）
- [ ] **触发条件**：是否有明确的激活条件？（不应该是"随意触发"）
- [ ] **代价**：是否消耗了合理的资源？（动作、法术位、每日次数等）

### 常见设计错误 ❌

1. **低等级给予震慑/缓慢**
   - ❌ 错误："1级能力，命中后震慑1"
   - ✅ 正确："1级能力，命中后目标战栗（-1状态减值）"

2. **无限制使用的动作经济效果**
   - ❌ 错误："被动能力，你的攻击可以震慑目标1轮"
   - ✅ 正确："每战斗1次，你可以尝试震慑目标（需要豁免）"

3. **无豁免的持续debuff**
   - ❌ 错误："目标缓慢1持续1分钟，无豁免"
   - ✅ 正确："目标缓慢1持续1分钟（每轮结束可豁免移除）"

4. **无限制的加速**
   - ❌ 错误："你获得加速1，额外动作可用于任何用途"
   - ✅ 正确："你获得加速1，额外动作只能用于打击或移动"

5. **持续时间过长的震慑**
   - ❌ 错误："目标震慑1持续1分钟"
   - ✅ 正确："目标震慑1直到其下一回合结束"



### 攻击加值的特殊性
**为什么攻击加值如此宝贵**：
- PF2e使用熟练加值系统，角色数值紧密平衡
- +1攻击约等于+5%命中率，+5%重击率
- +2攻击可能改变战斗结果
- 攻击加值应该是稀有资源，不应轻易给予

### 等级缩放公式参考

在 PF2e 中，大多数数值效果应该随角色等级增长。以下是常用的等级缩放公式：

#### 临时生命值公式

**弱效果（无限制或频繁触发）**：
- 【@actor.level】 - 等级点临时HP（1级=1点，10级=10点）
- 【@actor.level * 2】 - 等级×2点临时HP（1级=2点，10级=20点）
- 【max(1, floor(@actor.level / 2))】 - 等级÷2点（向下，最少1）（1级=1点，2级=1点，10级=5点）

**中等效果（每战斗1次或有代价）**：
- 【@actor.level * 2】 - 等级×2点（1级=2点，10级=20点）
- 【@actor.level * 3】 - 等级×3点（1级=3点，10级=30点）
- 【@actor.level + 5】 - 等级+5点（1级=6点，10级=15点）

**强效果（每天1次或严格限制）**：
- 【@actor.level * 3】 - 等级×3点（1级=3点，10级=30点）
- 【@actor.level * 4】 - 等级×4点（1级=4点，10级=40点）
- 【@actor.level * 5】 - 等级×5点（1级=5点，10级=50点）

#### 伤害加值公式

**持续性伤害加值**（无限制使用）：
- 【floor(@actor.level / 4)】 - 每4级+1点（1级=0点，4级=1点，8级=2点）
- 【max(1, floor(@actor.level / 4))】 - 每4级+1点（最少1）（1级=1点，4级=1点，8级=2点）
- 【floor(@actor.level / 2)】 - 每2级+1点（1级=0点，2级=1点，10级=5点）

**一次性伤害加值**（有限制）：
- 【@actor.level】 - 等级点伤害（1级=1点，10级=10点）
- 【@actor.level * 2】 - 等级×2点伤害（1级=2点，10级=20点）
- 【floor(@actor.level / 2)d6】 - 伤害骰随等级增长（2级=1d6，10级=5d6）

**伤害骰数量公式**：
- 【(1+floor(@actor.level/4))d6】 - 基础1d6，每4级+1d6（1级=1d6，5级=2d6，9级=3d6）
- 【max(1, floor(@actor.level/2))d6】 - 每2级1d6（最少1）（1级=1d6，2级=1d6，10级=5d6）
- 【max(1, floor(@actor.level/3))d6】 - 每3级1d6，最少1d6（1级=1d6，6级=2d6）

#### 治疗效果公式

**小治疗**（频繁使用）：
- 【@actor.level】 - 等级点治疗（1级=1点，10级=10点）
- 【1d8 + @actor.level】 - 1d8加等级（1级平均=5.5点，10级平均=14.5点）
- 【max(1, floor(@actor.level / 2))d6】 - 伤害骰随等级（最少1）（1级=1d6，2级=1d6，10级=5d6）

**中等治疗**（每战斗1-2次）：
- 【@actor.level * 2】 - 等级×2点（1级=2点，10级=20点）
- 【2d8 + @actor.level】 - 2d8加等级（1级平均=10点，10级平均=19点）
- 【@actor.level d6】 - 等级个d6（1级=1d6，10级=10d6）

**强力治疗**（每天1次）：
- 【@actor.level * 3】 - 等级×3点（1级=3点，10级=30点）
- 【@actor.level d8】 - 等级个d8（1级=1d8，10级=10d8）
- 【(@actor.level * 2)d6】 - 等级×2个d6（1级=2d6，10级=20d6）

**治疗按钮格式**（在描述中创建可点击的治疗按钮）：
- 固定治疗：@Damage[1d8[healing]]
- 带加值：@Damage[(1d8+4)[healing]]
- 等级缩放：@Damage[(@actor.level)d6[healing]]
- 复杂公式：@Damage[(2d8+@actor.level)[healing]]
- **注意**：healing 必须用英文，放在方括号内作为伤害类型

#### 持续伤害公式

**持续伤害**通常较低，因为可能持续多轮：
- 【max(1, floor(@actor.level / 4))d6】 - 每4级1d6（最少1d6），或任意期望值与之相当的伤害

#### 距离/范围公式

**区域范围**：
- 【5 + (@actor.level * 5)】 - 5尺基础，每级+5尺（1级=10尺，10级=55尺）
- 【10 + floor(@actor.level / 2) * 5】 - 10尺基础，每2级+5尺（1级=10尺，10级=30尺）
- 【max(10, @actor.level * 2)】 - 等级×2尺，最少10尺

**投掷距离**：
- 【30 + (@actor.level * 5)】 - 30尺基础，每级+5尺（1级=35尺，10级=80尺）
- 【60】 - 固定距离（如果效果不应缩放）

#### 持续时间公式

**轮数**：
- 【@actor.level】 - 等级轮（1级=1轮，10级=10轮）
- 【max(1, floor(@actor.level / 2))】 - 等级÷2轮（最少1）（1级=1轮，2级=1轮，10级=5轮）
- 【max(1, @actor.level)】 - 等级轮，最少1轮

**分钟数**：
- 【@actor.level】 - 等级分钟
- 【@actor.level * 10】 - 等级×10分钟

#### 检定DC公式

**职业DC**：
- 【@actor.attributes.classDC.value】 - 自动使用角色的职业DC

**自定义DC**：
- 【15 + @actor.level】 - 基础DC15，每级+1（1级=16，10级=25）
- 【10 + (@actor.level * 1.5)】 - 基础DC10，每级+1.5（向下取整）
- 【max(15, 10 + @actor.level)】 - 等级+10，最少15

#### 数学函数

PF2e 支持以下数学函数：
- 【floor(x)】 - 向下取整（PF2e默认取整方式）
- 【max(a, b)】 - 取最大值
- 【min(a, b)】 - 取最小值
- 【abs(x)】 - 绝对值

**注意**：
- PF2e规则默认使用**向下取整**
- 如需"向上取整"效果，使用 max(1, floor(x)) 确保最小值为1
- 避免使用 ceil() 函数，因为Foundry VTT的Roll系统可能不支持

#### 常用属性引用

- 【@actor.level】 - 角色等级
- 【@actor.abilities.str.mod】 - 力量修正
- 【@actor.abilities.dex.mod】 - 敏捷修正
- 【@actor.abilities.con.mod】 - 体质修正
- 【@actor.abilities.int.mod】 - 智力修正
- 【@actor.abilities.wis.mod】 - 感知修正
- 【@actor.abilities.cha.mod】 - 魅力修正
- 【@actor.abilities.classDC.value】 - 职业DC
- 【@item.level】 - 物品等级

#### 使用示例

**描述中使用**：
  <p>你获得等于你等级2倍的临时生命值。</p>

**Rule Element中实现**：
  { "key": "TempHP", "value": "@actor.level * 2" }

**伤害中使用**：
  <p>造成@Damage[(@actor.level)d6[fire]]火焰伤害。</p>

**复杂公式示例**：
  描述：<p>你获得等于你等级的临时生命值（最少5点）。</p>
  实现：{ "key": "TempHP", "value": "max(5, @actor.level)" }

---

## 18. 使用指南

在描述机制时：
1. **明确动作类型和成本**
2. **说明使用频次限制**
3. **详细描述触发条件**（如适用）
4. **具体量化效果数值**
5. **标注持续时间**
6. **使用正确的修正值类型**
7. **包含必要的前置条件**
8. **考虑与其他机制的交互**
9. **如果是戏法，遵循戏法设计原则**（无限施放、自动升环、效果较弱）

记住：清晰 > 复杂，具体 > 模糊，平衡 > 强力

### 特别提醒
- **戏法（0环）**: 效果必须适合无限施放，伤害基准1d4-1d6，自动升环
- **动作经济效果**: 震慑/缓慢/加速等极其强力，需要严格限制
- **修正值类型**: 同类型不堆叠，这是PF2e平衡的核心
`;

/**
 * PF2e规则机制知识服务
 */
export class PF2eMechanicsKnowledgeService {
  private static instance: PF2eMechanicsKnowledgeService;

  private constructor() {}

  public static getInstance(): PF2eMechanicsKnowledgeService {
    if (!PF2eMechanicsKnowledgeService.instance) {
      PF2eMechanicsKnowledgeService.instance = new PF2eMechanicsKnowledgeService();
    }
    return PF2eMechanicsKnowledgeService.instance;
  }

  /**
   * 获取完整的PF2e规则机制知识库
   */
  public getFullKnowledge(): string {
    return PF2E_MECHANICS_KNOWLEDGE;
  }

  /**
   * 获取简化版知识（用于token限制场景）
   */
  public getSimplifiedKnowledge(): string {
    return `# PF2e 核心规则要点

## 动作系统
- 单动作◆ / 双动作◆◆ / 三动作◆◆◆ / 自由◇ / 反应↻ / 被动

## 频次限制
- 无限制 / 每轮一次 / 每战斗一次 / 每天X次

## 修正值类型（同类型不堆叠，这是核心平衡机制）
- 环境加值 (Circumstance) - 较少见，战术操作
- 状态加值 (Status) - 较容易获得，法术/能力
- 物品加值 (Item) - 需要装备支持

## 加值范围（PF2e数值紧密平衡）
- 典型范围：+1到+3
- +1 = 显著效果
- +2 = 非常强力
- +3 = 极其罕见
- 攻击加值特别宝贵，不应轻易给予

## ⚠️ 戏法（0环法术）的特殊性
**戏法是无限施放的基础法术，效果必须严格控制！**

### 戏法三大特性
1. **无限施放** - 不消耗法术位，可无限使用
2. **自动升环** - 随施法者等级自动提升（通常每2级增强）
3. **效果较弱** - 必须明显弱于同环级法术

## ⚠️ 动作经济效果（极其强力，谨慎使用）
**在PF2e中，动作数是核心平衡点！**

### 震慑 (Stunned) - 失去动作
- 震慑1: 🔴强效果，3级+，每战斗1次，持续1轮
- 震慑2: 🔴🔴极强，10级+，每天1次或大失败
- 震慑3+: 🔴🔴🔴战局改变，15级+，极严格限制

### 缓慢 (Slowed) - 减少动作
- 缓慢1: 🟠强效果，5级+，需要豁免，持续1分钟（允许每轮豁免移除）
- 缓慢2: 🟠🟠极强，10级+，每天1次，持续1-3轮

### 加速 (Quickened) - 增加动作
- 加速: 🟢强效果，5级+（对应3环法术），每天1次，持续1分钟
- **关键**: 必须限制额外动作用途（如"只能用于打击或移动"）
- ❌ 绝不给予"无限制用途的额外动作"

### 动作经济效果设计原则
1. 等级门槛高（最低3级+）
2. 严格频次限制
3. 持续时间短
4. 需要豁免检定
5. 加速必须限制用途

## 机制描述要素
1. 动作类型和成本
2. 频次限制
3. 触发条件（反应动作必需）
4. 具体数值效果（基于等级合理）
5. 持续时间
6. 前置条件

## 平衡原则
- 动作成本 ↔ 效果强度
- 频次限制 ↔ 效果强度
- 持续时间 ↔ 效果强度
- 伤害基于等级递增（低级1-2d6，中级3-5d6，高级6-10d6）
- **动作经济效果 = 极高价值，必须严格限制**`;
  }
}

